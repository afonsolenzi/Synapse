{
	"name": "D3_SQLDW_MusicService_Cleanup",
	"properties": {
		"folder": {
			"name": "Music Service"
		},
		"content": {
			"query": "-- DROP TABLE musicService.userdetails_unq\n-- DROP TABLE musicService.UserDetails_Converted\n\nCREATE TABLE musicService.UserDetails_unq\n\t(\n\t[UserID] [varchar](100) NOT NULL,\n\t[Gender] [varchar](50) NULL,\n\t[Age] [int] NULL,\n\t[Country] [varchar](50) NULL,\n\t[SignupString] [varchar](50) NULL\n\t)\nWITH\n\t(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED INDEX (UserID)\n\t);\nGO\n\n-- load through COPY\nCOPY INTO musicService.UserDetails_unq\n([UserID], [Gender], [Age], [Country], [SignupString])\nFROM 'https://warnerdatalake.dfs.core.windows.net/synapse/musicdata/UserDetailsUnquoted.csv'\nWITH\n(\n\tFILE_TYPE = 'CSV'\n\t,MAXERRORS = 0\n    ,FIRSTROW=2\n\t,ERRORFILE = 'https://warnerdatalake.dfs.core.windows.net/synapse/sqldw/errors/'\n\t,IDENTITY_INSERT = 'OFF'\n)OPTION (LABEL = 'Load musicService.UserDetailsUnquoted')\nGO\n\n\n-- what if we want to convert the string date to a real date?\n-- DROP TABLE musicService.userdetails_conv;\n\nselect UserId, Gender, Age, Country, SignupString, try_convert(date,SignupString,107) SignupDate\ninto musicService.userdetails_conv\nfrom musicService.UserDetails_unq;\n\n-- did it work?\nselect count(*) from musicService.userdetails_conv\nwhere SignupDate is null;\n\nselect top 20 * from musicService.userdetails_conv\nwhere SignupDate is null;\n\n-- whats going on\nselect top 20 * from musicService.UserDetails_unq;\n\n-- Create a file format that will simply load everything as text\n-- drop external file format LineFileFormat;\n\nCREATE EXTERNAL FILE FORMAT LineFileFormat \nWITH \n(   FORMAT_TYPE = DELIMITEDTEXT\n);\nGO\n\n-- Create a stage table that is simply a list of strings read from the file\n-- drop external table [stage].FileReader\nCREATE EXTERNAL TABLE [stage].FileReader\n(\n    fileLine nvarchar(max)\n)\nWITH\n(\n    LOCATION='/musicdata/UserDetailsUnquoted.csv' \n,   DATA_SOURCE = synapse\n,   FILE_FORMAT = LineFileFormat\n,   REJECT_TYPE = VALUE\n,   REJECT_VALUE = 0\n)\nGO\n\n-- look at the contents\nSELECT TOP 20 * FROM [stage].FileReader;\n\n-- let's adjust\nDROP TABLE musicService.UserDetails_unq;\n\nCREATE TABLE musicService.UserDetails_unq\n\t(\n\t[UserID] [varchar](100) NOT NULL,\n\t[Gender] [varchar](50) NULL,\n\t[Age] [int] NULL,\n\t[Country] [varchar](50) NULL,\n\t[SignupString] [varchar](50) NULL,\n    [SignupYear] [varchar](50) NULL\n\t)\nWITH\n\t(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED INDEX (UserID)\n\t);\nGO\n\n-- load through COPY\nCOPY INTO musicService.UserDetails_unq\n([UserID], [Gender], [Age], [Country], [SignupString],[SignupYear])\nFROM 'https://warnerdatalake.dfs.core.windows.net/synapse/musicdata/UserDetailsUnquoted.csv'\nWITH\n(\n\tFILE_TYPE = 'CSV'\n\t,MAXERRORS = 0\n    ,FIRSTROW=2\n\t,ERRORFILE = 'https://warnerdatalake.dfs.core.windows.net/synapse/sqldw/errors/'\n\t,IDENTITY_INSERT = 'OFF'\n)OPTION (LABEL = 'Load musicService.UserDetailsUnquoted')\nGO\n\n-- look again\nselect top 20 * from musicService.UserDetails_unq;\n\nupdate musicService.UserDetails_unq\nset [SignupString] = [SignupString] + ', ' + [SignupYear];\n\nselect top 20 * from musicService.UserDetails_unq;\n\n--let's try again to convert the string date to a real date\ndrop table musicService.userdetails_conv;\n\nselect UserId, Gender, Age, Country, SignupString, SignupYear, try_convert(date,SignupString,107) SignupDate\ninto musicService.userdetails_conv\nfrom musicService.UserDetails_unq;\n\n-- did it work?\nselect count(*) from musicService.userdetails_conv\nwhere SignupDate is null;\n\nselect top 20 * from musicService.userdetails_conv\nwhere SignupDate is null;\n\ndrop table musicService.userdetails_conv;\n\n-- let's adjust\nDROP TABLE musicService.UserDetails_unq;\n\nCREATE TABLE musicService.UserDetails_unq\n\t(\n\t[UserID] [varchar](100) NOT NULL,\n\t[Gender] [varchar](50) NULL,\n\t[Age] [int] NULL,\n\t[Country] [varchar](50) NULL,\n\t[SignupString] [varchar](50) NULL,\n    [SignupYear] [varchar](50) NULL,\n    [SignupYear2] [varchar](50) NULL\n\t)\nWITH\n\t(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED INDEX (UserID)\n\t);\nGO\n\n-- load through COPY\nCOPY INTO musicService.UserDetails_unq\n([UserID], [Gender], [Age], [Country], [SignupString],[SignupYear],[SignupYear2])\nFROM 'https://warnerdatalake.dfs.core.windows.net/synapse/musicdata/UserDetailsUnquoted.csv'\nWITH\n(\n\tFILE_TYPE = 'CSV'\n\t,MAXERRORS = 0\n    ,FIRSTROW=2\n\t,ERRORFILE = 'https://warnerdatalake.dfs.core.windows.net/synapse/sqldw/errors/'\n\t,IDENTITY_INSERT = 'OFF'\n)OPTION (LABEL = 'Load musicService.UserDetailsUnquoted')\nGO\n\n-- first look at the ones that have no data in the last field, meaning the country names are OK\nselect top 20 * from musicService.UserDetails_unq\nwhere SignupYear2 is null;\n\n-- build the full date string\nupdate musicService.UserDetails_unq\nset [SignupString] = [SignupString] + ', ' + [SignupYear]\nwhere SignupYear2 is null;\n\n-- check results\nselect top 20 * from musicService.UserDetails_unq\nwhere SignupYear2 is null;\n\n-- now with the problem countries...\nselect top 20 * from musicService.UserDetails_unq\nwhere SignupYear2 is not null;\n\n-- first let's fix the country names\nupdate musicService.UserDetails_unq\nset Country=[SignupString] + ' ' + [Country]\nWHERE SignupYear2 is not null;\n\n-- check results\nselect top 20 * from musicService.UserDetails_unq\nwhere SignupYear2 is not null;\n\n-- then fix the signup dates\nupdate musicService.UserDetails_unq\nset SignupString=[SignupYear] + ', ' + [SignupYear2]\nWHERE SignupYear2 is not null;\n\n-- check results\nselect top 20 * from musicService.UserDetails_unq\nwhere SignupYear2 is not null;\n\n-- ok so let's try to make the new table\nCREATE TABLE musicService.UserDetails_Converted\nWITH\n\t(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED INDEX (UserID)\n\t)\n    AS\nSELECT UserID,Gender,Age,Country,try_convert(date,SignupString,107) SignupDate from musicService.UserDetails_unq;\nGO\n\n-- are there records pending with issues?\nSELECT count(*) FROM musicService.UserDetails_Converted\nwhere SignupDate is null;\n\n-- verify contents\nSELECT top 100 * FROM musicService.UserDetails_Converted;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "SQLDW",
				"databaseName": "SQLDW"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}